<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Druvienas ‚Äî mƒÅjas lietotne</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{--bg:#0f1115;--panel:#141820;--ink:#e8eaee;--muted:#9aa3b2;--border:#1f2532;--accent:#4b8cff}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .app{max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;position:sticky;top:0;background:var(--bg);z-index:5}
    .lang{display:flex;gap:8px}
    .btn{border:1px solid var(--border);background:#121723;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .btn.active{outline:2px solid var(--accent)}
    .layout{display:grid;grid-template-columns:340px 1fr;gap:16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px}

    /* –ª–æ–≥–æ—Ç–∏–ø —Å–ª–µ–≤–∞ */
    .houseCard{position:relative;overflow:hidden}
    .houseBox{display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;min-height:320px}
    .houseImg{width:70%;max-width:320px;height:auto;border-radius:12px;display:block;transition:all .25s ease}

    /* –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º ‚Äî –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø—É–Ω–∫—Ç–∞ –º–µ–Ω—é */
    .compact .houseImg{
      width:110px;max-width:none;
      position:absolute;right:12px;top:12px;
      border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.35);
      cursor:pointer;
    }
    .hint{color:var(--muted);font-size:12px;margin-top:6px}

    /* –ø—Ä–∞–≤—ã–π –±–ª–æ–∫ */
    .menuItem{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#121723;cursor:pointer;margin-bottom:10px}
    .menuItem:hover{outline:2px solid rgba(75,140,255,.5)}
    .sectionTitle{font-weight:800;margin:0 0 8px}
    .sectionText{color:var(--muted);line-height:1.5;min-height:60px}
    .error{color:#ffb4b4;background:#381b1b;border:1px solid #5b2a2a;padding:10px 12px;border-radius:10px}
    @media (max-width:900px){.layout{grid-template-columns:1fr}}

    /* ===== –†–µ–∑—É–ª—å—Ç–∞—Ç—ã: –¥–æ–º –∏ ¬´–¥–æ—Å–∫–∞¬ª ===== */
    .stage{position:relative;border:1px solid var(--border);border-radius:12px;padding:12px;background:#0f141f}
    svg{width:100%;height:auto;display:block}
    .entrance{cursor:pointer;transition:filter .15s}
    .entrance:hover{filter:drop-shadow(0 0 10px rgba(75,140,255,.6))}

    .board{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      background:#101623;border:1px solid #263147;border-radius:14px;
      box-shadow:0 16px 40px rgba(0,0,0,.5);
      width:min(420px,90%);padding:16px;display:none;
    }
    .board.show{display:block}
    .boardTitle{font-weight:800;margin:0 0 10px}
    .row{display:flex;justify-content:space-between;gap:12px;margin:8px 0}
    .closeBtn{position:absolute;right:10px;top:8px;border:1px solid var(--border);background:#1a2030;color:var(--ink);border-radius:10px;padding:4px 8px;cursor:pointer}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h3 id="pageTitle" style="margin:0">Druvienas iela 36 ‚Äî ‚Ä¶</h3>
      <div class="lang">
        <button id="ruBtn" class="btn">üá∑üá∫ RU</button>
        <button id="lvBtn" class="btn">üá±üáª LV</button>
      </div>
    </header>

    <div id="grid" class="layout">
      <!-- –∫—Ä—É–ø–Ω–æ–µ –ª–æ–≥–æ, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ—Ç–æ–º —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∫–Ω–æ–ø–∫–æ–π ¬´–¥–æ–º–æ–π¬ª -->
      <div class="card houseCard">
        <div class="houseBox">
          <img id="houseImg" class="houseImg" src="./house.png" alt="Druvienas iela">
          <div class="hint" id="homeHint" style="display:none">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –¥–æ–º, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</div>
        </div>
      </div>

      <!-- –º–µ–Ω—é + –∫–æ–Ω—Ç–µ–Ω—Ç -->
      <div class="card">
        <div id="menu"></div>
        <hr style="border:none;border-top:1px solid var(--border);margin:12px 0">
        <div id="contentArea">
          <div id="contentTitle" class="sectionTitle"></div>
          <div id="contentText" class="sectionText"></div>
          <div id="resultsRoot" style="display:none"></div>
          <div id="errorBox" class="error" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ==== –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ==== */
    const tg = window.Telegram?.WebApp; tg?.ready(); tg?.expand();
    const user = tg?.initDataUnsafe?.user;
    const displayName = user?.first_name || (user?.username ? '@'+user.username : 'guest');
    const pageTitle = document.getElementById('pageTitle');
    pageTitle.textContent = `Druvienas iela 36 ‚Äî ${displayName}`;

    const state = { lang:'ru', data:null, active:null };
    const qsLang = new URLSearchParams(location.search).get('lang');
    state.lang = (qsLang || user?.language_code || 'ru').toLowerCase().startsWith('lv') ? 'lv' : 'ru';

    const $ = s => document.querySelector(s);
    const grid=$('#grid'), ruBtn=$('#ruBtn'), lvBtn=$('#lvBtn');
    const menuBox=$('#menu'), contentTitle=$('#contentTitle'), contentText=$('#contentText'), errorBox=$('#errorBox');
    const resultsRoot=$('#resultsRoot'), houseImg=$('#houseImg'), homeHint=$('#homeHint');

    ruBtn.onclick = ()=>{ state.lang='ru'; applyLang(); };
    lvBtn.onclick = ()=>{ state.lang='lv'; applyLang(); };

    /* ==== –¥–∞–Ω–Ω—ã–µ –º–µ–Ω—é/–∫–æ–Ω—Ç–µ–Ω—Ç–∞ –±–µ—Ä—ë–º –∏–∑ data.json ==== */
    async function loadJSON(){
      try{
        const res = await fetch(`./data.json?v=${Date.now()}`);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      }catch(e){
        errorBox.style.display='block';
        errorBox.textContent = `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å data.json (${e.message}).`;
        throw e;
      }
    }

    /* ==== –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–µ–Ω—é ==== */
    function applyLang(){
      const d = state.data; if(!d) return;
      const L = state.lang;

      ruBtn.classList.toggle('active', L==='ru');
      lvBtn.classList.toggle('active', L==='lv');

      menuBox.innerHTML='';
      d.menu.forEach(item=>{
        const el=document.createElement('div');
        el.className='menuItem';
        el.dataset.id=item.id;
        el.innerHTML=`<span>${L==='lv'?item.lv:item.ru}</span><span>‚Ä∫</span>`;
        el.onclick=()=>openSection(item.id);
        menuBox.appendChild(el);
      });

      // —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω –±–µ–∑ compact
      grid.classList.remove('compact');
      homeHint.style.display='none';
      contentTitle.textContent = '';
      contentText.textContent  = '';
      resultsRoot.style.display='none';
      resultsRoot.innerHTML = '';
      state.active = null;
    }

    function openSection(id){
      const d=state.data, L=state.lang;
      const item = d.menu.find(m=>m.id===id);
      const title = L==='lv' ? item.lv : item.ru;
      const blob  = d.content[id] ? (L==='lv' ? d.content[id].lv : d.content[id].ru) : '';

      state.active = id;

      // —Å–≤–µ—Ä–Ω—É—Ç—å –ª–æ–≥–æ—Ç–∏–ø + —Å–¥–µ–ª–∞—Ç—å –µ–≥–æ ¬´–¥–æ–º–æ–π¬ª
      grid.classList.add('compact');
      homeHint.style.display='block';
      houseImg.onclick = ()=>applyLang(); // –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é

      contentTitle.textContent = title;
      contentText.textContent  = (id==='results') ? '' : blob;

      if (id==='results') {
        renderResults(); // —Ä–∏—Å—É–µ–º –¥–æ–º —Å –ø–æ–¥—ä–µ–∑–¥–∞–º–∏ –∑–¥–µ—Å—å –∂–µ
      } else {
        resultsRoot.style.display='none';
        resultsRoot.innerHTML='';
      }
    }

    /* ==== —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–π ‚Äî –¥–æ–º —Å 5 –ø–æ–¥—ä–µ–∑–¥–∞–º–∏ + ¬´–¥–æ—Å–∫–∞¬ª ==== */
    const VOTES = { // –≤—Ä–µ–º–µ–Ω–Ω–æ –≤ –∫–æ–¥–µ; –ø–æ—Ç–æ–º –ø–æ–¥—Ö–≤–∞—Ç–∏–º votes.json
      entrances: [
        { id:1, yes:9,  no:0 },
        { id:2, yes:12, no:0 },
        { id:3, yes:14, no:1 },
        { id:4, yes:8,  no:0 },
        { id:5, yes:9,  no:0 }
      ]
    };

    function renderResults(){
      resultsRoot.style.display='block';
      resultsRoot.innerHTML = `
        <div class="stage">
          <svg viewBox="0 0 900 560" aria-label="–î–æ–º 5 –ø–æ–¥—ä–µ–∑–¥–æ–≤">
            <rect x="0" y="0" width="900" height="560" fill="#d9eefc"/>
            <rect x="160" y="60" width="680" height="440" fill="#f5f7fb" stroke="#2c3446" stroke-width="4" rx="10"/>
            <rect x="60"  y="20" width="140" height="520" fill="#c54735" stroke="#2c3446" stroke-width="4" rx="10"/>

            <!-- –ø—è—Ç—å –ø–æ–¥—ä–µ–∑–¥–æ–≤ (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ –∑–æ–Ω—ã) -->
            <g class="entrance" data-id="1" transform="translate(60,420)">
              <rect width="140" height="60" fill="rgba(75,140,255,.08)" stroke="#2c3446" stroke-width="2" rx="8"/>
              <rect x="28" y="8" width="84" height="44" fill="#5a3b32" stroke="#2c3446" stroke-width="3" rx="4"/>
            </g>
            <g class="entrance" data-id="2" transform="translate(220,420)">
              <rect width="120" height="60" fill="rgba(75,140,255,.08)" stroke="#2c3446" stroke-width="2" rx="8"/>
              <rect x="18" y="8" width="84" height="44" fill="#5a3b32" stroke="#2c3446" stroke-width="3" rx="4"/>
            </g>
            <g class="entrance" data-id="3" transform="translate(380,420)">
              <rect width="120" height="60" fill="rgba(75,140,255,.08)" stroke="#2c3446" stroke-width="2" rx="8"/>
              <rect x="18" y="8" width="84" height="44" fill="#5a3b32" stroke="#2c3446" stroke-width="3" rx="4"/>
            </g>
            <g class="entrance" data-id="4" transform="translate(540,420)">
              <rect width="120" height="60" fill="rgba(75,140,255,.08)" stroke="#2c3446" stroke-width="2" rx="8"/>
              <rect x="18" y="8" width="84" height="44" fill="#5a3b32" stroke="#2c3446" stroke-width="3" rx="4"/>
            </g>
            <g class="entrance" data-id="5" transform="translate(700,420)">
              <rect width="120" height="60" fill="rgba(75,140,255,.08)" stroke="#2c3446" stroke-width="2" rx="8"/>
              <rect x="18" y="8" width="84" height="44" fill="#5a3b32" stroke="#2c3446" stroke-width="3" rx="4"/>
            </g>
          </svg>

          <div class="board" id="board">
            <button class="closeBtn" id="closeBoard">‚úï</button>
            <div class="boardTitle">–ü–æ–¥—ä–µ–∑–¥ <span id="bPid">1</span></div>
            <div class="row"><span>‚úÖ –ó–∞</span><span id="bYes">0</span></div>
            <div class="row"><span>‚ùå –ü—Ä–æ—Ç–∏–≤</span><span id="bNo">0</span></div>
          </div>
        </div>
      `;

      const stage = resultsRoot.querySelector('.stage');
      const board = resultsRoot.querySelector('#board');
      const bPid = resultsRoot.querySelector('#bPid');
      const bYes = resultsRoot.querySelector('#bYes');
      const bNo  = resultsRoot.querySelector('#bNo');
      const close = resultsRoot.querySelector('#closeBoard');

      stage.querySelectorAll('.entrance').forEach(el=>{
        el.addEventListener('click', e=>{
          const id = +el.dataset.id;
          const row = VOTES.entrances.find(x=>x.id===id) || {yes:0, no:0};
          bPid.textContent = id;
          bYes.textContent = row.yes;
          bNo.textContent  = row.no;
          board.classList.add('show');
        });
      });

      close.onclick = ()=>board.classList.remove('show');
    }

    /* –∑–∞–ø—É—Å–∫ */
    loadJSON().then(json=>{ state.data=json; applyLang(); }).catch(console.error);
  </script>
</body>
</html>
